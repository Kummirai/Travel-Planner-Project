<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Planner - Trip</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Open+Sans:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./src/css/trip.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="container">
        <div class="navbar-content">
          <a class="navbar-brand" href="index.html">
            <i class="fas fa-plane-departure me-2"></i>Travel Planner
          </a>
          <ul class="navbar-nav">
            <li><a class="nav-link" href="dashboard.html">Dashboard</a></li>
            <li>
              <a class="nav-link active" href="trip.html?action=new"
                >New Trip</a
              >
            </li>
            <li class="dropdown">
              <button class="dropdown-toggle" id="navbarDropdown">
                <i class="fas fa-user-circle me-1"></i> User Name
              </button>
              <div class="dropdown-menu" id="dropdownMenu">
                <a class="dropdown-item" href="#">Profile</a>
                <a class="dropdown-item" href="#" id="logoutBtn">Logout</a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="py-4">
      <div class="container">
        <!-- Trip Header -->
        <div class="trip-header">
          <div class="trip-info">
            <h1 id="tripName">New Trip</h1>
            <p class="trip-dates" id="tripDates"></p>
          </div>
          <div class="trip-actions">
            <button class="btn btn-outline-secondary" id="saveTripBtn">
              <i class="far fa-save me-1"></i> Save
            </button>
            <button class="btn btn-primary" id="exportTripBtn">
              <i class="fas fa-file-export me-1"></i> Export
            </button>
          </div>
        </div>

        <!-- Trip Navigation -->
        <ul class="nav-tabs" id="tripTabs">
          <li class="nav-item">
            <button class="nav-link active" data-tab="details">
              <i class="fas fa-info-circle me-1"></i> Details
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-tab="itinerary">
              <i class="fas fa-calendar-alt me-1"></i> Itinerary
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-tab="flights">
              <i class="fas fa-plane me-1"></i> Flights
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-tab="hotels">
              <i class="fas fa-hotel me-1"></i> Hotels
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-tab="budget">
              <i class="fas fa-wallet me-1"></i> Budget
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="tripTabContent">
          <!-- Details Tab -->
          <div class="tab-pane active" id="details">
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Trip Information</h5>
                    <form id="tripDetailsForm">
                      <div class="form-group">
                        <label for="tripNameInput" class="form-label"
                          >Trip Name</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="tripNameInput"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="tripDestination" class="form-label"
                          >Destination</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="tripDestination"
                          required
                        />
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="tripStartDate" class="form-label"
                              >Start Date</label
                            >
                            <input
                              type="date"
                              class="form-control"
                              id="tripStartDate"
                              required
                            />
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="tripEndDate" class="form-label"
                              >End Date</label
                            >
                            <input
                              type="date"
                              class="form-control"
                              id="tripEndDate"
                              required
                            />
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="tripDescription" class="form-label"
                          >Description</label
                        >
                        <textarea
                          class="form-control"
                          id="tripDescription"
                          rows="3"
                        ></textarea>
                      </div>
                      <div class="form-group">
                        <label for="tripStatus" class="form-label"
                          >Status</label
                        >
                        <select class="form-select" id="tripStatus">
                          <option value="Planning">Planning</option>
                          <option value="In Progress">In Progress</option>
                          <option value="Completed">Completed</option>
                          <option value="Cancelled">Cancelled</option>
                        </select>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Trip Preferences</h5>
                    <div class="form-group">
                      <label class="form-label">Interests</label>
                      <div class="interests-grid">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="interestAdventure"
                          />
                          <label
                            class="form-check-label"
                            for="interestAdventure"
                            >Adventure</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="interestCulture"
                          />
                          <label class="form-check-label" for="interestCulture"
                            >Culture</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="interestFood"
                          />
                          <label class="form-check-label" for="interestFood"
                            >Food</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="interestNature"
                          />
                          <label class="form-check-label" for="interestNature"
                            >Nature</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="interestRelaxation"
                          />
                          <label
                            class="form-check-label"
                            for="interestRelaxation"
                            >Relaxation</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="interestShopping"
                          />
                          <label class="form-check-label" for="interestShopping"
                            >Shopping</label
                          >
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="tripBudget" class="form-label"
                        >Budget Range</label
                      >
                      <select class="form-select" id="tripBudget">
                        <option value="Budget">Budget ($)</option>
                        <option value="Mid-range">Mid-range ($$)</option>
                        <option value="Luxury">Luxury ($$$)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="tripPace" class="form-label"
                        >Travel Pace</label
                      >
                      <select class="form-select" id="tripPace">
                        <option value="Relaxed">Relaxed</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Fast-paced">Fast-paced</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Itinerary Tab -->
          <div class="tab-pane" id="itinerary">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-3"
                >
                  <h5 class="card-title mb-0">Daily Itinerary</h5>
                  <button class="btn btn-sm btn-primary" id="addDayBtn">
                    <i class="fas fa-plus me-1"></i> Add Day
                  </button>
                </div>
                <div class="accordion" id="itineraryAccordion">
                  <div class="empty-state" id="noDaysMessage">
                    <i class="far fa-calendar-alt"></i>
                    <h4>No days added yet</h4>
                    <p>Start by adding your first day</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Flights Tab -->
          <div class="tab-pane" id="flights">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-4">Flight Information</h5>
                <div class="row">
                  <div class="col-md-6">
                    <form id="flightSearchForm">
                      <div class="form-group">
                        <label for="flightOrigin" class="form-label"
                          >From</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="flightOrigin"
                          placeholder="City or Airport"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="flightDestination" class="form-label"
                          >To</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="flightDestination"
                          placeholder="City or Airport"
                          required
                        />
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="flightDepartureDate" class="form-label"
                              >Departure Date</label
                            >
                            <input
                              type="date"
                              class="form-control"
                              id="flightDepartureDate"
                              required
                            />
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="flightReturnDate" class="form-label"
                              >Return Date (optional)</label
                            >
                            <input
                              type="date"
                              class="form-control"
                              id="flightReturnDate"
                            />
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="flightPassengers" class="form-label"
                          >Passengers</label
                        >
                        <select class="form-select" id="flightPassengers">
                          <option value="1">1 Adult</option>
                          <option value="2">2 Adults</option>
                          <option value="3">3 Adults</option>
                          <option value="4">4 Adults</option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i> Search Flights
                      </button>
                    </form>
                  </div>
                  <div class="col-md-6">
                    <div class="bg-light">
                      <h6 class="mb-3">Saved Flights</h6>
                      <div id="savedFlightsContainer">
                        <p class="text-muted mb-0">No flights saved yet</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-4 d-none" id="flightResultsContainer">
                  <h6 class="mb-3">Flight Results</h6>
                  <div class="list-group" id="flightResultsList">
                    <!-- Flight results will be added here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Hotels Tab -->
          <div class="tab-pane" id="hotels">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-4">Hotel Information</h5>
                <div class="row">
                  <div class="col-md-6">
                    <form id="hotelSearchForm">
                      <div class="form-group">
                        <label for="hotelLocation" class="form-label"
                          >Location</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="hotelLocation"
                          placeholder="City or Hotel Name"
                          required
                        />
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="hotelCheckIn" class="form-label"
                              >Check-in Date</label
                            >
                            <input
                              type="date"
                              class="form-control"
                              id="hotelCheckIn"
                              required
                            />
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="hotelCheckOut" class="form-label"
                              >Check-out Date</label
                            >
                            <input
                              type="date"
                              class="form-control"
                              id="hotelCheckOut"
                              required
                            />
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="hotelGuests" class="form-label"
                              >Guests</label
                            >
                            <select class="form-select" id="hotelGuests">
                              <option value="1">1 Guest</option>
                              <option value="2">2 Guests</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./src/js/util.js"></script>
    <script src="./src/js/auth.js"></script>
    <script src="./src/js/trip.js"></script>
    <script src="./src/js/itinerary.js"></script>
    <script src="./src/js/api.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (!localStorage.getItem("currentUser")) {
          window.location.href = "auth.html?action=login";
          return;
        }

        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (currentUser && currentUser.name) {
          document.querySelector(
            ".dropdown-toggle"
          ).innerHTML = `<i class="fas fa-user-circle me-1"></i> ${currentUser.name}`;
        }

        document
          .getElementById("logoutBtn")
          .addEventListener("click", function () {
            localStorage.removeItem("currentUser");
            window.location.href = "auth.html?action=login";
          });

        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get("id");
        const action = urlParams.get("action");

        if (action === "new") {
          initializeNewTrip();
        } else if (tripId) {
          loadTrip(tripId);
        } else {
          window.location.href = "dashboard.html";
        }

        initializeBudgetChart();
      });

      function initializeNewTrip() {
        const today = new Date();
        const tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);

        document.getElementById("tripStartDate").valueAsDate = today;
        document.getElementById("tripEndDate").valueAsDate = tomorrow;
        document.getElementById("flightDepartureDate").valueAsDate = today;
        document.getElementById("flightReturnDate").valueAsDate = tomorrow;
        document.getElementById("hotelCheckIn").valueAsDate = today;
        document.getElementById("hotelCheckOut").valueAsDate = tomorrow;

        document.getElementById("tripNameInput").value = "My New Trip";
      }

      function loadTrip(tripId) {
        const trips = JSON.parse(localStorage.getItem("trips")) || [];
        const trip = trips.find((t) => t.id === tripId);

        if (!trip) {
          alert("Trip not found");
          window.location.href = "dashboard.html";
          return;
        }

        document.getElementById("tripName").textContent = trip.name;
        document.getElementById("tripNameInput").value = trip.name;
        document.getElementById("tripDestination").value = trip.destination;
        document.getElementById("tripStartDate").valueAsDate = new Date(
          trip.startDate
        );
        document.getElementById("tripEndDate").valueAsDate = new Date(
          trip.endDate
        );
        document.getElementById("tripDescription").value =
          trip.description || "";
        document.getElementById("tripStatus").value = trip.status || "Planning";

        const startDate = formatDate(trip.startDate);
        const endDate = formatDate(trip.endDate);
        document.getElementById(
          "tripDates"
        ).textContent = `${startDate} - ${endDate}`;

        if (trip.days && trip.days.length > 0) {
          document.getElementById("noDaysMessage").classList.add("d-none");
          loadItineraryDays(trip.days);
        }

        if (trip.flights && trip.flights.length > 0) {
          loadSavedFlights(trip.flights);
        }

        if (trip.hotels && trip.hotels.length > 0) {
          loadSavedHotels(trip.hotels);
        }

        if (trip.budget) {
          updateBudgetDisplay(trip.budget);
        }
      }

      function initializeBudgetChart() {
        const ctx = document.getElementById("budgetChart").getContext("2d");
        const budgetChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [
              "Flights",
              "Hotels",
              "Food",
              "Activities",
              "Transportation",
              "Other",
            ],
            datasets: [
              {
                data: [0, 0, 0, 0, 0, 0],
                backgroundColor: [
                  "#4FC3F7",
                  "#FF7043",
                  "#66BB6A",
                  "#FFEE58",
                  "#26A69A",
                  "#BDBDBD",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
              },
            },
          },
        });
      }

      function updateBudgetDisplay(budgetData) {
        document.getElementById(
          "estimatedBudget"
        ).textContent = `$${budgetData.estimatedTotal.toFixed(2)}`;
        document.getElementById(
          "actualExpenses"
        ).textContent = `$${budgetData.actualTotal.toFixed(2)}`;

        const remaining = budgetData.estimatedTotal - budgetData.actualTotal;
        document.getElementById(
          "remainingBudget"
        ).textContent = `$${remaining.toFixed(2)}`;

        const progressPercentage =
          (budgetData.actualTotal / budgetData.estimatedTotal) * 100;
        document.getElementById("budgetProgressBar").style.width = `${Math.min(
          progressPercentage,
          100
        )}%`;

        const categories = [
          "Flights",
          "Hotels",
          "Food",
          "Activities",
          "Transportation",
          "Other",
        ];
        const tableBody = document.getElementById("expenseTableBody");
        tableBody.innerHTML = "";

        categories.forEach((category) => {
          const estimated = budgetData.estimated[category] || 0;
          const actual = budgetData.actual[category] || 0;

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${category}</td>
                    <td class="text-end">$${estimated.toFixed(2)}</td>
                    <td class="text-end">$${actual.toFixed(2)}</td>
                `;
          tableBody.appendChild(row);
        });

        updateBudgetChart([
          budgetData.actual.Flights || 0,
          budgetData.actual.Hotels || 0,
          budgetData.actual.Food || 0,
          budgetData.actual.Activities || 0,
          budgetData.actual.Transportation || 0,
          budgetData.actual.Other || 0,
        ]);
      }

      function updateBudgetChart(data) {
        const chart = Chart.getChart("budgetChart");
        if (chart) {
          chart.data.datasets[0].data = data;
          chart.update();
        }
      }
    </script>
  </body>
</html>
